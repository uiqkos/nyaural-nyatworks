{% extends "base.html" %}
{% block content %}
  <h1 class="nya-text" style="margin-top: 5%; margin-bottom: -100px">Результаты анализа</h1>

  <div class="container search" id="mainContainer">

  </div>

  <script type="text/javascript">

    let floatColor = function (r) {
      let red = 255 - (255 * (r < 0.5) * (1 - r * 2))
      let green = 255 - (255 * (r > 0.5) * (r - 0.5) * 2)
      let color = (r > 0.6) ? 'white' : 'black'
      return `background-color: rgb(${red}, ${green}, 0); color: ${color}`
    }

    let borderFloatColor = function (r) {
      return "rgba(255, 133, 0, " + (1 - (r / 4)).toString() + ")"
    }

    function pill(target, value, variants) {
      let color
      if (value === null) {
        value = '?'
        color = 'background-color: #4ed5ec; color: #ffffff'
      } else {
        if (variants !== undefined) {
          if (value < 0.5) {
            target = variants[0]
            value = 1 - value
          } else {
            target = variants[1]
          }
        }
        color = floatColor(value)
        value = Math.round(value * 100)
      }

      return '<span class="rounded-pill badge" style="' + color + '">' + target + ' ' + value + '%</span>'
    }

    function commentToHTML(comment, style) {
      return '<div style="' + style + '">' +
        '<p class="nya-text">' + comment.author + '</p>' +
        '<p style="margin-left: 1%">' + comment.text + '</p>' +
        pill('toxic', comment.toxic) + ' ' + pill('negative', comment.sentiment, ['positive', 'negative']) + ' ' + pill('sarcasm', comment.sarcasm) +
        '</div>'
    }

    function expand(comment, nested_level) {
      let html_text = ''
      let style = 'border-left: 2px solid ' + borderFloatColor(nested_level + 1)

      if (nested_level) {
        html_text += '<div class="list-group nested">'
      } else {
        html_text += '<div class="list-group">'
      }

      html_text += commentToHTML(comment)

      if (comment.comments.length !== 0) {
        comment.comments.forEach(function (nested) {
          html_text += '<div class="comment list-group-item">'
          html_text += expand(nested, nested_level + 1, style)
          html_text += '</div>'
        })
      }
      html_text += '</div>'
      return html_text
    }

    mainContainer = document.getElementById('mainContainer')
    let expanded = expand({{ comments | safe }}, 0)
    mainContainer.innerHTML += '<div class="list-group">'
    mainContainer.innerHTML += expanded
    mainContainer.innerHTML += '</div>'
  </script>

{% endblock %}
